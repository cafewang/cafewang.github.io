---
layout: post
title:  "arthas实用教程"
date:   2022-11-28 14:05:31 +0800
categories: debug
---

# arthas实用教程

## arthas安装

1. 进入容器
2. 下载 arthasjar包
   `wget https://alibaba.github.io/arthas/arthas-boot.jar`
3. 运行arthas
   `java -jar arthas-boot.jar`
4. 选择springboot java进程

## arthas典型使用场景

### 拦截方法的执行，查看参数、返回值、异常或者所属对象

**watch**命令可以增强指定方法，打印方法的参数、返回值、异常和执行它的对象信息，格式为:

`watch 完整类路径 方法名 打印格式 过滤条件 -x 打印深度 -n 执行次数`

栗子：`watch com.daimler.otr.infrastructure.repository.entity.partstock.DealerPartCatalog getDealerPartDescriptionByLanguage`

默认打印格式为`{params, target, returnObj}`，`{a, b, c}`为arthas中的数组写法，可以同时打印多个参数

可用的参数有:

+ params 类型为 Object数组，可通过 params[0] 访问数组元素，params.length 获取长度
+ target 调用方法的对象
+ returnObj 返回值
+ throwExp 抛出的异常对象

也可以只打一个参数，比如`watch class method 'returnObj'`

进阶使用

+ 过滤条件
  可以设置条件过滤无关的调用，仅条件触发时打印
  `watch java.util.stream.Stream collect 'returnObj' 'returnObj instanceof java.util.HashMap && returnObj.containsKey("A0000000029")' -n 5 -x 2`
  仅关注返回结果类型为HashMap且包含指定键的调用

+ 输出转json
  arthas默认输出并不标准，可以调用系统中的静态方法转换输出
  `watch java.util.stream.Stream collect '@com.daimler.otr.rwo.utils.JsonUtils@marshal(returnObj)' -n 5 -x 2`
  @类名@静态方法为arthas中执行静态方法的写法

+ 类型转换
  由于params类型为Object，无法调用参数中的方法，需要先转换成对应的类型
  `watch com.daimler.otr.infrastructure.repository.entity.partstock.DealerPartCatalog getDealerPartDescriptionByLanguage 'returnObj' '"A0000001100".equals(target.getClass().cast(target).getPartNoWithoutFormat())' -n 5 -x 2`

+ 默认不会拦截`java.*`包下的系统类，调用以下命令可以开启该功能

  `options unsafe true`

  `由于引用系统类的地方太多，命令执行时间较长，可能导致容器重启，慎用！`

### 执行spring容器中特定bean的方法

有时我们想快速调用某段代码，但是代码的入口并不容易触发，可以尝试以下方式

1.需要能通过静态方法或静态变量(可以是private)访问ApplicationContext对象，比如下面这个类

```java
@Component
public class SpringApplicationContext implements ApplicationContextAware {

    private static ApplicationContext contextSingleton;

    private static synchronized void setContextInternal(ApplicationContext context) {
        contextSingleton = context;
    }

    @Override
    public void setApplicationContext(final ApplicationContext context) {
        setContextInternal(context);
    }

    public static <T> T getBean(Class<T> clazz) {
        return contextSingleton.getBean(clazz);
    }
}
```

2.调用 `sc -d 类名 ` 获取类加载器的哈希值
![image][hash]

如上图 哈希值为 `6d21714c`

3.调用 `ognl -c 6d21714c @com.daimler.otr.utils.SpringApplicationContext@contextSingleton.getBean("paymentConfirmedServiceRecordService").getYesterdayPaymentConfirmedServiceRecords(@org.springframework.data.domain.PageRequest@of(2, 2)) -x 3`

上述命令从容器中获取名称为`paymentConfirmedServiceRecordService`的bean对象，执行了它的`getYesterdayPaymentConfirmedServiceRecords`方法

